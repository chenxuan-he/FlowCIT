# Codes for Conditional Independence Test by Conditional Continuous Normalizing Flow Models

## Reproduction Guide

-   Each bash file contains command lines to reproduce results of one scenario.
    -   For instance: **model1_1_n500.sh** reproduces the results of model 1, scenario 1, with sample size $n=500$. We take it as an example.
    -   First, it generates data and stores at the *data/* folder, e.g.,
        ```bash
        nohup python model_generate_data.py --model=1 --sim_type=1 --alpha=.00 --nsim=200 --d=3 --p=3 --q=3 --n=500
    -   Second, it runs `Rscript model_CLZ.R` to perform the CLZ and KCI test by R, e.g.,
        ```bash
        nohup Rscript model_CLZ.R --model=1 --sim_type=1 --alpha=.00 --n=500 --p=3 --q=3 --d=3 --n_cpu=50 --bandwidth=.2 &> model1_CLZ_s1_a00.txt &
    -   Third, it runs `Rscript model_CLZ_result.R` to get the results, e.g.,
        ```bash
        Rscript model_CLZ_result.R --model=1 --sim_type=1 --n=500 --p=3 --q=3 --d=3 --bandwidth=.2 --alpha=.00
    -   We then manually collect the results outputed by `Rscript model_CLZ_result.R` to **model1_simtype1-n-500.csv**.
    -   Fourth, it runs `python model.py` to perform FlowCIT, FCIT, and CDC tests by python, e.g.,
        ```bash
        nohup python -u model.py --model=1 --sim_type=1 --alpha=.00 --n=500 --p=3 --q=3 --d=3 --par_task=5 --gpu=1 --cpu=000-040 --nsim=200 &> model1_s1_a00.txt &
    -   Fifth, it runs `python model_result.py` to get the results and stores them at **model1_simtype1-n-500-x-3-y-3-z-3.csv**, e.g.,
        ```bash
        python model_result.py --model=1 --sim_type=1 --alphas="0.0,0.05,0.1,0.15,0.2" --n=500 --p=3 --q=3 --d=3 --hidden_num=64 
    -   We then manually copy the results from **model1_simtype1-n-500-x-3-y-3-z-3.csv** to **model1_simtype1-n-500.csv**.
    -   Sixth, it runs `python model_GCIT.py` to perform GCIT test by python, e.g.,
        ```bash
        nohup python -u model_GCIT.py --model=1 --sim_type=1 --alpha=.00 --n=500 --p=3 --q=3 --d=3 --par_task=50 --cpu=000-050 --nsim=200 --test_prop=.02 &> model1_s1_GCIT_a00.txt &
    -   Note that the GCIT test requires tensorflow version at 1.13.1, and python>=3.6. Other versions are not sensitive.
    -   Seventh, it runs `python model_result.py` to get the results and stores them at **model1_simtype1-n-500-x-3-y-3-z-3-GCIT.csv**, e.g.,
        ```bash
        python model_result.py --model=1 --sim_type=1 --alphas="0.0,0.05,0.1,0.15,0.2" --n=500 --p=3 --q=3 --d=3 --hidden_num=64 --GCIT=True --GCIT_test_prop=.02
    -   We then manually copy the results from **model1_simtype1-n-500-x-3-y-3-z-3-GCIT.csv** to **model1_simtype1-n-500.csv**.
    -   Eighth, it runs `python model_plot.py` to plot by `matplotlib` and stores at the folder *plots/*, e.g.,
        ```bash
        python model_plot.py --model=1 --sim_type=1 --n=500 --alphas="0.0,0.05,0.1,0.15,0.2" --legend=True

## Explanations for the Files

-   Files with prefix *functions_*
    -   **functions_generate_data.py**
        -   The main code to generate data and write out the folder *data/*. The python and R codes then read the data back.
    -   **functions_generate_data.R**
        -   Read the data generated by functions_generate_data.py.
    -   **functions_gcit.py**
        -   Code adapted from: https://github.com/vanderschaarlab/mlforhealthlabpub/tree/main/alg/gcit
        -   We revised the code to make the splitting proportion (training/test ratio) as an input to maintain size under $H_0$. For each set of simulation, the ratio is then fixed.
    -   **functions_flow.py**
        -   The main code to implement a continuous normalizing flow training as proposed by us.
    -   **functions_test.py**
        -   The code to implement tests, including the permutation test proposed by us, the FCIT test, and the CDC test.

-   Files with prefix *model_*
    -   **model_CLZ.R** and **model_CLZ_result.R**
        -   Perform the CLZ test and the KCI test, and then read the result back to output the empirical size and power.
        -   Similar to GCIT test, the bandwidth of CLZ test is tuned to maintain the size under $H_0$ and then fixed for $H_1$.
    -   **model_GCIT.py**
        -   A separate file to implement the GCIT test.
    -   **model_generate_data.py**
        -   Call the functions from **functions_generate_data.py** to generate data.
    -   **model_result.py** and **model_plot.py**
        -   Get the results implemented by python, and plot by matplotlib.
    -   **model.py**
        -   The main code to implement FlowCIT, FCIT, and CDC tests.

-   Folders
    -   *CLZ/*
        -   The folder contains some necessary codes and intermediate files to implement the CLZ test.
    -   *data/*
        -   Intermediate folder to store the data generated by **model_generate_data.py**.
    -   *plots/*
        -   Store the plots generated by **model_plot.py**
    -   *results/*
        -   Intermediate folder to store the results outputed by **model_GCIT.py** and **model.py**